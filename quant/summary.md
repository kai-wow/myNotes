# 逐笔委托数据处理
## 逐笔委托数据处理
### 1. 解压
联通的数据有些是压缩包，需要进行解压
### 2. 拆分
初始数据（解压后）为一天一个csv文件，存有当天所有证券的逐笔委托数据；
需要将其进行拆分，每个证券的当天的数据单独存入一个 parquet 文件
### 3. 统一数据口径和字段
对拆分后 逐笔委托数据 进行处理
1. 深交所： 
- 合并 逐笔成交中的 撤单信息
    i. 在逐笔成交里，筛选撤单订单： 成交的买卖单号中有一方为0 (即缺失buyno / sellno) ，且订单成交价格为0
    ii. 将撤单订单单号和逐笔委托单号匹配，获得订单价格，并加入到逐笔委托数据里
- 处理市价单价格
    i. 主买市价单，用最高价
    ii. 主卖市价单，用最低价
2016年6月之前，看vxy的价格是否很奇怪
2. 上交所： 
- 合并 逐笔成交中的 市价委托/即时成交信息
    i. 在逐笔成交里，寻找 i) 单号相同 (orderdata.OrderNo = tradedata.buyno / sellno) 
            ii) 成交方向(主买/主卖)一致 (orderdata.OrderBSFlag = tradedata.bs) 的订单；
    ii. 将这些订单的成交量加到逐笔委托里
- 处理市价单价格
    i. 成交订单中单号不在委托数据中的，即为即时全部成交的市价单
    ii. 处理此类订单的价格：主买，用最高价；主卖，用最低价
3. 统一字段为 OrderNo, SecurityID, UpdateTime, OrderPx, OrderQty, Side, OrderType
### 检查
看是否存在 1) 逐笔委托有数据，逐笔成交无数据的证券
          2) 逐笔成交有数据，逐笔委托无数据的证券 （发现逐笔委托原始数据有些日期数据缺失，为同事误删）

## 相关知识点
### 主买/主卖
逐笔成交订单分为主买和主卖。
主买： 买单吃卖单；主卖： 卖单吃买单（即成交双方里主动吃掉盘口挂单的一方）

### 集合竞价和连续竞价
集合竞价：集合竞价是指对一段时间内接收的买卖申报一次性集中撮合的竞价方式。


## 整合高频逐笔委托数据
### 教训
学会看 glances 的 CPU, MEM, swap，尤其是 Memory。
很多次代码中断（SIGSEGV(-11) 或 SIGSEGV(-9)），都是因为内存严重不够，MEM 高达 90%，导致进程被强行 kill。
这种时间就应该放弃一次性计算完所有因子的想法，退而求其次，要么分开求因子，要么分别求几段时间的因子，再整合，甚至可以二者结合。
（我最终选择了二者结合）
```
TerminatedWorkerError: A worker process managed by the executor was unexpectedly terminated. This could be caused by a segmentation fault while calling the function or by an excessive memory usage causing the Operating System to kill the worker.  The exit codes of the workers are {SIGSEGV(-11)}
```
# 挖因子
## 基本常识
对股票选股策略来说，日频就是高频了
## 单因子测试
### 流程
- 原因子测试
    1. 去极值
    2. 标准化
    3. 中性化（前后对比）
    4. 标准化
    5. 计算 IC： 因子值与下期收益率的截面相关系数 or
    计算 RankIC： 因子排序分值与下期收益率的截面相关系数
    > 序关系不受异常值的影响，无需正态假设，也无需去极值和正态化处理（见 https://xueqiu.com/1685554336/84071774）
- 筛选因子： 满足各指标标准，主要看 多空收益曲线、ic值、换手率；再超额
- 对有潜力的因子进行改进：
    1. 移动平滑：能降低换手率 （ma后因子值更稳定，rank后取的前10%更稳定，降低换手）
    2. 在更高频的数据上计算统计量：eg 30min数据算 vol, skew, kurt, entropy
    > 为什么计算 波动率选股：羊群效应，大家都买的时候买可能不赚钱

> 改进流程举例：大单成交金额因子
    huge_tradamt_ratio 表现较好，多空收益0.25，且曲线平稳，分隔明显，**但换手率高，0.7左右**
    1.  借鉴系列研报的修改：更改大单阈值，eg log+标准差+滚动多日
    2. 降换手率：因子移动平均（MA3），换手率降到0.3，**但仍须降低**
    3. 降换手率：滚动多天的数据计算因子，换手率降到0.25~0.2，但发现近期超额变平（甚至向下），**说明得换回单日数据**
    4. 单日因子拆分：
        - 用更高频因子的统计量：计算 30min因子值，计算每日的 vol, skew, kurt, entropy
        - 将每日交易时间拆分（如，4个小时拆分开），看每个交易段的因子进行择时的效果 【借鉴系列研报】
    5. 换成交金额因子，为大单成交笔数因子
### 中性化
#### 为什么要中性化
希望剔除待使用数据中的多余的风险暴露（其他因素的影响）。

一些因子本身会受到其他因子的影响，而导致用其选股会有一定偏向。例如，行业和市值大小对估值因子有影响。
#### 如何中性化
回归，以原始因子为被解释变量Y，风险因子（eg行业因子，市值因子）为解释变量X，提取残差作为中性化后的新因子。
**本质上是组内减均值除以标准差（eg行业组内）**。简单总结，中性化体现了针对某个标准（例如行业或者市值）规范化/标准化的结果。

这样使得新因子和风险因子正交，相关性为0，剩下的是专属信息


### 各指标标准
1. 多空组合：稳定上涨/下跌；衰退缓慢；19年至22.7大概要到0.15左右
2. ic值：**最重要**是平稳，其次是值越大越好，但0.02附近即可
超额
> 初期看这俩就行
3. 市场等权超额：平稳上涨；19年至22.7大概要到约50%
4. 指数超额：上涨；19年至22.7大概要到约50%
5. 单边换手率：较低；90%的换手率直接pass，成本过高; 换手率30%以下比较好

除此之外，还需要看：
- 超额/多空收益的斜率：eg. 哪块回撤比较大；最近是否仍在涨

## 因子相加
不同于因子组合。
对于一些相关性很高，或诞生于同一理念的因子，可以直接对他们进行相加来求得新因子。
## 因子相关性
看因子与常规低频因子之间的截面相关性。
> eg. 市值因子、换手率因子、波动率因子、基本面因子。

根据相关性分析的结果，投资者在对因子进行正交处理时，可重点剔除行业、市值以及常规技术类因子的影响。




# 订单流

市场操纵者会说谎，会欺骗，但无法隐藏他们在市场中的足迹。

订单流让投资者用最快的速度读懂供需关系。通过不同价位的主动买单量和主动卖单量对比，我们能知道趋势是否延续和反转，知道成交量里隐藏着多少野性的冲动。

简单的成交量，无法区分是代表需求的力量还是代表供给的力量。
## 订单流
数字代表主动订单的成交量。（即市价单的成交量）
## 市价 限价
市价单会引起供需的不平衡，从而形成一波趋势。
限价单（被动型多/空头）形成了市场的阻力位和支撑位。

每一笔交易总会出现一个主动型交易者，一个被动型交易者，一个市价单，一个限价单。

被动型交易者通常是机构等主力，他们的动作通常标志着市场的拐点。
## 
底部主动卖方枯竭，说明支撑带稳固。

# 一些异常市场表现的解释
## 21年初策略普遍有大幅回撤
公募基金 + 白马股

股民大幅涌向公募基金，而公募为了稳健，大多持有的是行业龙头股（白马股），进一步推高了白马股
的价格；但这种收益不可持续，因此后续有所回落。

策略超额有大幅回撤，主要原因在于，选股中白马股不多，因而收益即使不低，相较指数的超额依旧
大幅回落。
